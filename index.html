<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pretoria Weather</title>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            color: #fff;
            transition: background 1s ease;
        }

        /* === DYNAMIC BACKGROUNDS === */
        .bg-clear { background: linear-gradient(135deg, #2196F3 0%, #64B5F6 40%, #81D4FA 100%); }
        .bg-cloudy { background: linear-gradient(135deg, #78909C 0%, #B0BEC5 50%, #90A4AE 100%); }
        .bg-rain { background: linear-gradient(135deg, #37474F 0%, #546E7A 40%, #455A64 100%); }
        .bg-storm { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .bg-snow { background: linear-gradient(135deg, #CFD8DC 0%, #ECEFF1 50%, #B0BEC5 100%); color: #37474F; }
        .bg-night { background: linear-gradient(135deg, #0d1b2a 0%, #1b2838 40%, #0a1628 100%); }

        /* === WEATHER ANIMATIONS === */
        .weather-effects {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; overflow: hidden;
        }

        /* Rain */
        .rain-drop {
            position: absolute; top: -20px;
            width: 2px; background: linear-gradient(transparent, rgba(174, 194, 224, 0.6));
            animation: rainfall linear infinite;
        }
        @keyframes rainfall {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(110vh); opacity: 0.3; }
        }

        /* Snow */
        .snowflake {
            position: absolute; top: -10px;
            width: 8px; height: 8px;
            background: radial-gradient(circle, #fff 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            animation: snowfall linear infinite;
        }
        @keyframes snowfall {
            0% { transform: translateY(-10px) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(110vh) translateX(80px) rotate(360deg); opacity: 0; }
        }

        /* Stars */
        .star {
            position: absolute;
            width: 2px; height: 2px;
            background: #fff; border-radius: 50%;
            animation: twinkle ease-in-out infinite alternate;
        }
        @keyframes twinkle {
            0% { opacity: 0.2; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.5); }
        }

        /* Sun glow */
        .sun-glow {
            position: absolute; top: 40px; right: 60px;
            width: 120px; height: 120px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,235,59,0.8) 0%, rgba(255,193,7,0.3) 40%, transparent 70%);
            animation: sunPulse 4s ease-in-out infinite alternate;
        }
        @keyframes sunPulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.2); opacity: 1; }
        }
        .sun-glow::after {
            content: ''; position: absolute; top: -30px; left: -30px;
            width: 180px; height: 180px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,235,59,0.2) 0%, transparent 70%);
            animation: sunPulse 6s ease-in-out infinite alternate-reverse;
        }

        /* Lightning */
        .lightning-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.15); opacity: 0;
            pointer-events: none; z-index: 2;
            animation: lightningBolt 4s infinite;
        }
        @keyframes lightningBolt {
            0%, 89%, 91%, 93%, 100% { opacity: 0; }
            90% { opacity: 1; }
            92% { opacity: 0.5; }
        }

        /* Cloud puffs */
        .cloud {
            position: absolute;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            animation: cloudDrift linear infinite;
        }
        @keyframes cloudDrift {
            0% { transform: translateX(-200px); }
            100% { transform: translateX(calc(100vw + 200px)); }
        }

        /* === LAYOUT === */
        .app { position: relative; z-index: 3; padding: 1rem; max-width: 900px; margin: 0 auto; }

        /* Hero */
        .hero {
            text-align: center; padding: 3rem 1rem 2rem;
        }
        .hero-icon { font-size: 5rem; line-height: 1; margin-bottom: 0.5rem; }
        .hero-temp { font-size: 5rem; font-weight: 200; line-height: 1; }
        .hero-desc { font-size: 1.2rem; opacity: 0.85; margin: 0.5rem 0; }
        .hero-feels { font-size: 0.95rem; opacity: 0.7; }

        /* Detail cards */
        .details {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem; margin: 1.5rem 0;
        }
        .detail-card {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px; padding: 1rem; text-align: center;
        }
        .detail-label { font-size: 0.75rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.05em; }
        .detail-value { font-size: 1.4rem; font-weight: 600; margin-top: 0.25rem; }
        .detail-icon { font-size: 1.3rem; }

        /* Section titles */
        .section-title {
            font-size: 1rem; font-weight: 600; opacity: 0.8;
            margin: 1.5rem 0 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
        }

        /* Hourly scroll */
        .hourly-scroll {
            display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.5rem 0;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .hourly-scroll::-webkit-scrollbar { display: none; }
        .hourly-item {
            flex: 0 0 70px; text-align: center;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 0.75rem 0.5rem;
        }
        .hourly-time { font-size: 0.75rem; opacity: 0.7; }
        .hourly-icon { font-size: 1.3rem; margin: 0.3rem 0; }
        .hourly-temp { font-size: 0.9rem; font-weight: 600; }

        /* 7-day forecast */
        .forecast-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .forecast-row {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px; padding: 0.75rem 1rem;
        }
        .forecast-day { width: 50px; font-size: 0.9rem; font-weight: 600; }
        .forecast-icon { font-size: 1.3rem; width: 35px; text-align: center; }
        .forecast-precip { font-size: 0.75rem; opacity: 0.6; width: 45px; text-align: center; }
        .forecast-temps { display: flex; gap: 0.5rem; align-items: center; width: 90px; justify-content: flex-end; }
        .forecast-high { font-weight: 600; }
        .forecast-low { opacity: 0.5; }
        .forecast-bar {
            flex: 1; height: 4px; border-radius: 2px; margin: 0 0.75rem;
            background: rgba(255,255,255,0.15); position: relative; min-width: 60px;
        }
        .forecast-bar-fill {
            position: absolute; top: 0; height: 100%; border-radius: 2px;
            background: linear-gradient(90deg, #64B5F6, #FF8A65);
        }

        /* Updated timestamp */
        .updated { text-align: center; font-size: 0.75rem; opacity: 0.5; padding: 1.5rem 0; }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }

        /* Responsive */
        @media (max-width: 480px) {
            .hero-temp { font-size: 3.5rem; }
            .hero-icon { font-size: 3.5rem; }
            .details { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body class="bg-clear">
    <div class="weather-effects" id="effects"></div>
    <div class="lightning-flash" id="lightning" style="display:none;"></div>

    <div class="app">
        <div class="hero" id="hero">
            <div class="hero-icon skeleton" style="height:5rem;width:5rem;margin:0 auto;">&nbsp;</div>
            <div class="hero-temp skeleton" style="height:4rem;width:200px;margin:0.5rem auto;">&nbsp;</div>
        </div>

        <div class="details" id="details">
            <div class="detail-card skeleton" style="height:80px;">&nbsp;</div>
            <div class="detail-card skeleton" style="height:80px;">&nbsp;</div>
            <div class="detail-card skeleton" style="height:80px;">&nbsp;</div>
            <div class="detail-card skeleton" style="height:80px;">&nbsp;</div>
        </div>

        <div class="section-title">Next 12 Hours</div>
        <div class="hourly-scroll" id="hourly">
            <div class="hourly-item skeleton" style="height:100px;">&nbsp;</div>
        </div>

        <div class="section-title">7-Day Forecast</div>
        <div class="forecast-list" id="forecast"></div>

        <div class="updated" id="updated"></div>
    </div>

    <script>
        const API = 'https://api.open-meteo.com/v1/forecast?latitude=-25.7479&longitude=28.2293&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,uv_index&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset&timezone=Africa/Johannesburg&forecast_days=7';

        const WMO = {
            0: ['Clear Sky', '‚òÄÔ∏è', 'clear'],
            1: ['Mainly Clear', 'üå§Ô∏è', 'clear'],
            2: ['Partly Cloudy', '‚õÖ', 'cloudy'],
            3: ['Overcast', '‚òÅÔ∏è', 'cloudy'],
            45: ['Fog', 'üå´Ô∏è', 'cloudy'],
            48: ['Rime Fog', 'üå´Ô∏è', 'cloudy'],
            51: ['Light Drizzle', 'üå¶Ô∏è', 'rain'],
            53: ['Drizzle', 'üå¶Ô∏è', 'rain'],
            55: ['Heavy Drizzle', 'üåßÔ∏è', 'rain'],
            61: ['Light Rain', 'üå¶Ô∏è', 'rain'],
            63: ['Rain', 'üåßÔ∏è', 'rain'],
            65: ['Heavy Rain', 'üåßÔ∏è', 'rain'],
            71: ['Light Snow', 'üå®Ô∏è', 'snow'],
            73: ['Snow', '‚ùÑÔ∏è', 'snow'],
            75: ['Heavy Snow', '‚ùÑÔ∏è', 'snow'],
            80: ['Light Showers', 'üå¶Ô∏è', 'rain'],
            81: ['Showers', 'üåßÔ∏è', 'rain'],
            82: ['Heavy Showers', 'üåßÔ∏è', 'rain'],
            95: ['Thunderstorm', '‚õàÔ∏è', 'storm'],
            96: ['Thunderstorm + Hail', '‚õàÔ∏è', 'storm'],
            99: ['Heavy Thunderstorm', '‚õàÔ∏è', 'storm']
        };

        function getWMO(code) { return WMO[code] || ['Unknown', 'üå°Ô∏è', 'clear']; }

        function windDir(deg) {
            const d = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
            return d[Math.round(deg / 22.5) % 16];
        }

        // === WEATHER EFFECTS ===
        function clearEffects() {
            document.getElementById('effects').innerHTML = '';
            document.getElementById('lightning').style.display = 'none';
        }

        function createRain(intensity) {
            const el = document.getElementById('effects');
            const count = intensity === 'heavy' ? 120 : intensity === 'moderate' ? 70 : 35;
            for (let i = 0; i < count; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.height = (15 + Math.random() * 20) + 'px';
                drop.style.animationDuration = (0.4 + Math.random() * 0.4) + 's';
                drop.style.animationDelay = Math.random() * 2 + 's';
                drop.style.opacity = 0.3 + Math.random() * 0.4;
                el.appendChild(drop);
            }
        }

        function createSnow() {
            const el = document.getElementById('effects');
            for (let i = 0; i < 60; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.style.left = Math.random() * 100 + '%';
                const size = 4 + Math.random() * 8;
                flake.style.width = size + 'px';
                flake.style.height = size + 'px';
                flake.style.animationDuration = (4 + Math.random() * 6) + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                el.appendChild(flake);
            }
        }

        function createStars() {
            const el = document.getElementById('effects');
            for (let i = 0; i < 80; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 60 + '%';
                const size = 1 + Math.random() * 3;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.animationDuration = (2 + Math.random() * 4) + 's';
                star.style.animationDelay = Math.random() * 3 + 's';
                el.appendChild(star);
            }
        }

        function createSun() {
            const el = document.getElementById('effects');
            const sun = document.createElement('div');
            sun.className = 'sun-glow';
            el.appendChild(sun);
        }

        function createClouds() {
            const el = document.getElementById('effects');
            for (let i = 0; i < 5; i++) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.style.top = (10 + Math.random() * 30) + '%';
                const size = 100 + Math.random() * 200;
                cloud.style.width = size + 'px';
                cloud.style.height = (size * 0.5) + 'px';
                cloud.style.animationDuration = (30 + Math.random() * 40) + 's';
                cloud.style.animationDelay = -(Math.random() * 40) + 's';
                el.appendChild(cloud);
            }
        }

        function applyEffects(code, isNight) {
            clearEffects();
            const [, , type] = getWMO(code);

            if (isNight) {
                document.body.className = 'bg-night';
                createStars();
                if (type === 'rain') createRain('moderate');
                if (type === 'storm') { createRain('heavy'); document.getElementById('lightning').style.display = 'block'; }
                if (type === 'snow') createSnow();
                return;
            }

            document.body.className = 'bg-' + type;
            switch(type) {
                case 'clear': createSun(); break;
                case 'cloudy': createClouds(); break;
                case 'rain':
                    createClouds();
                    createRain(code >= 63 ? 'heavy' : code >= 53 ? 'moderate' : 'light');
                    break;
                case 'storm':
                    createRain('heavy');
                    document.getElementById('lightning').style.display = 'block';
                    break;
                case 'snow': createSnow(); createClouds(); break;
            }
        }

        // === RENDER ===
        let lastData = null;

        async function fetchWeather() {
            try {
                const res = await fetch(API);
                if (!res.ok) throw new Error('API error');
                lastData = await res.json();
                render(lastData);
            } catch (e) {
                console.error('Fetch error:', e);
                if (lastData) render(lastData);
                else document.getElementById('hero').innerHTML = '<p style="padding:2rem;">Unable to load weather data. Will retry...</p>';
            }
        }

        function render(d) {
            const now = new Date();
            const sunrise = new Date(d.daily.sunrise[0]);
            const sunset = new Date(d.daily.sunset[0]);
            const isNight = now < sunrise || now > sunset;
            const code = d.current.weather_code;
            const [desc, icon] = getWMO(code);

            applyEffects(code, isNight);

            // Hero
            document.getElementById('hero').innerHTML = `
                <div class="hero-icon fade-in">${icon}</div>
                <div class="hero-temp fade-in">${Math.round(d.current.temperature_2m)}¬∞</div>
                <div class="hero-desc fade-in">${desc}</div>
                <div class="hero-feels fade-in">Feels like ${Math.round(d.current.apparent_temperature)}¬∞</div>
            `;

            // Details
            document.getElementById('details').innerHTML = `
                <div class="detail-card fade-in">
                    <div class="detail-icon">üíß</div>
                    <div class="detail-label">Humidity</div>
                    <div class="detail-value">${d.current.relative_humidity_2m}%</div>
                </div>
                <div class="detail-card fade-in">
                    <div class="detail-icon">üí®</div>
                    <div class="detail-label">Wind</div>
                    <div class="detail-value">${Math.round(d.current.wind_speed_10m)} km/h</div>
                    <div class="detail-label">${windDir(d.current.wind_direction_10m)}</div>
                </div>
                <div class="detail-card fade-in">
                    <div class="detail-icon">‚òÄÔ∏è</div>
                    <div class="detail-label">UV Index</div>
                    <div class="detail-value">${d.current.uv_index}</div>
                </div>
                <div class="detail-card fade-in">
                    <div class="detail-icon">${isNight ? 'üåÖ' : 'üåá'}</div>
                    <div class="detail-label">${isNight ? 'Sunrise' : 'Sunset'}</div>
                    <div class="detail-value">${(isNight ? sunrise : sunset).toLocaleTimeString('en-ZA', {hour:'2-digit',minute:'2-digit'})}</div>
                </div>
            `;

            // Hourly ‚Äî find current hour index
            const nowHour = now.getHours();
            const hourStart = d.hourly.time.findIndex(t => new Date(t).getHours() === nowHour && new Date(t).getDate() === now.getDate());
            const start = hourStart >= 0 ? hourStart : 0;
            document.getElementById('hourly').innerHTML = d.hourly.time.slice(start, start + 12).map((t, i) => {
                const idx = start + i;
                const h = new Date(t);
                return `<div class="hourly-item fade-in">
                    <div class="hourly-time">${i === 0 ? 'Now' : h.toLocaleTimeString('en-ZA', {hour:'2-digit', minute:'2-digit'})}</div>
                    <div class="hourly-icon">${getWMO(d.hourly.weather_code[idx])[1]}</div>
                    <div class="hourly-temp">${Math.round(d.hourly.temperature_2m[idx])}¬∞</div>
                </div>`;
            }).join('');

            // 7-day
            const allMax = d.daily.temperature_2m_max;
            const allMin = d.daily.temperature_2m_min;
            const globalMin = Math.min(...allMin);
            const globalMax = Math.max(...allMax);
            const range = globalMax - globalMin || 1;

            document.getElementById('forecast').innerHTML = d.daily.time.map((t, i) => {
                const day = new Date(t);
                const dayName = i === 0 ? 'Today' : day.toLocaleDateString('en-ZA', { weekday: 'short' });
                const lo = allMin[i], hi = allMax[i];
                const left = ((lo - globalMin) / range) * 100;
                const width = ((hi - lo) / range) * 100;
                const precip = d.daily.precipitation_probability_max[i];
                return `<div class="forecast-row fade-in">
                    <div class="forecast-day">${dayName}</div>
                    <div class="forecast-icon">${getWMO(d.daily.weather_code[i])[1]}</div>
                    <div class="forecast-precip">${precip > 0 ? 'üíß' + precip + '%' : ''}</div>
                    <div class="forecast-bar"><div class="forecast-bar-fill" style="left:${left}%;width:${Math.max(width, 5)}%"></div></div>
                    <div class="forecast-temps">
                        <span class="forecast-low">${Math.round(lo)}¬∞</span>
                        <span class="forecast-high">${Math.round(hi)}¬∞</span>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('updated').textContent = 'Updated ' + now.toLocaleTimeString('en-ZA', {hour:'2-digit', minute:'2-digit'});
        }

        fetchWeather();
        setInterval(fetchWeather, 15 * 60 * 1000);
    </script>
</body>
</html>
